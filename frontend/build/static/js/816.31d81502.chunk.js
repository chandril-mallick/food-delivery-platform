"use strict";(self.webpackChunkdabba_app=self.webpackChunkdabba_app||[]).push([[816],{8816:(e,r,t)=>{t.d(r,{default:()=>n});var a=t(2555),c=t(9786),o=t(5472),s=t(347);const n=new class{constructor(){this.recaptchaVerifier=null}initializeRecaptcha(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"recaptcha-container";this.cleanupRecaptcha();try{if("undefined"!==typeof window&&"undefined"!==typeof document){if(!document.getElementById(e))throw console.warn("reCAPTCHA container '".concat(e,"' not found in DOM. Make sure it exists in your component.")),new Error("reCAPTCHA container '".concat(e,"' not found"))}}catch(r){throw console.warn("DOM container check failed:",r),r}try{return this.recaptchaVerifier=new c.kT(s.j2,e,{size:"normal",theme:"light",callback:e=>{console.log("reCAPTCHA solved, response length:",null===e||void 0===e?void 0:e.length)},"expired-callback":()=>{console.log("reCAPTCHA expired, recreating..."),this.cleanupRecaptcha()},"error-callback":e=>{console.error("reCAPTCHA error:",e)}}),console.log("RecaptchaVerifier created successfully for Identity Platform"),this.recaptchaVerifier}catch(r){throw console.error("Failed to create RecaptchaVerifier:",r),r}}cleanupRecaptcha(){if(this.recaptchaVerifier&&"function"===typeof this.recaptchaVerifier.clear)try{this.recaptchaVerifier.clear()}catch(e){}this.recaptchaVerifier=null}async sendOTP(e){try{const t=(e||"").replace(/\D/g,"");let a="";a=t.startsWith("91")||e.startsWith("+")?"+".concat(t):"+91".concat(t),console.log("Identity Platform: Attempting to send OTP to:",a);const o=this.initializeRecaptcha();try{await o.render(),console.log("reCAPTCHA rendered successfully")}catch(r){console.warn("reCAPTCHA render warning:",r)}await new Promise(e=>setTimeout(e,1e3)),console.log("Identity Platform: RecaptchaVerifier ready, attempting signInWithPhoneNumber...");const n=await(0,c.ik)(s.j2,a,o);return console.log("Identity Platform: OTP sent successfully"),{success:!0,confirmationResult:n,message:"OTP sent successfully"}}catch(t){console.error("Identity Platform Error sending OTP:",{code:null===t||void 0===t?void 0:t.code,message:null===t||void 0===t?void 0:t.message,data:null===t||void 0===t?void 0:t.customData,stack:null===t||void 0===t?void 0:t.stack});let e="Failed to send OTP";return"auth/invalid-app-credential"===(null===t||void 0===t?void 0:t.code)?e="Identity Platform: App credentials invalid. This may be due to reCAPTCHA configuration or project settings.":"auth/captcha-check-failed"===(null===t||void 0===t?void 0:t.code)?e="reCAPTCHA verification failed. Please complete the reCAPTCHA and try again.":"auth/invalid-phone-number"===(null===t||void 0===t?void 0:t.code)?e="Invalid phone number format. Please check and try again.":"auth/quota-exceeded"===(null===t||void 0===t?void 0:t.code)?e="SMS quota exceeded. Please try again later.":"auth/too-many-requests"===(null===t||void 0===t?void 0:t.code)&&(e="\ud83c\udf89 Phone auth is working! Rate limit reached - please wait 15-30 minutes or try a different phone number."),{success:!1,error:e,errorCode:null===t||void 0===t?void 0:t.code}}}async verifyOTP(e,r){try{const t=(await e.confirm(r)).user;return await this.createOrUpdateUserProfile(t),{success:!0,user:t,message:"Login successful"}}catch(t){return console.error("Error verifying OTP:",t),{success:!1,error:"Invalid OTP. Please try again."}}}async createOrUpdateUserProfile(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{const t=(0,o.doc)(s.db,"users",e.uid),c=await(0,o.getDoc)(t),n=(0,a.A)({uid:e.uid,phoneNumber:e.phoneNumber,lastLogin:new Date,updatedAt:new Date},r);return c.exists()?await(0,o.updateDoc)(t,n):(n.createdAt=new Date,n.name=r.name||"",n.email=r.email||"",n.addresses=[],n.orderHistory=[],await(0,o.setDoc)(t,n)),n}catch(t){throw console.error("Error creating/updating user profile:",t),t}}async getUserProfile(e){try{const r=(0,o.doc)(s.db,"users",e),t=await(0,o.getDoc)(r);return t.exists()?t.data():null}catch(r){throw console.error("Error getting user profile:",r),r}}async updateUserProfile(e,r){try{const t=(0,o.doc)(s.db,"users",e),n=(0,a.A)((0,a.A)({},r),{},{updatedAt:new Date});return await(0,o.updateDoc)(t,n),r.name&&s.j2.currentUser&&await(0,c.r7)(s.j2.currentUser,{displayName:r.name}),{success:!0,message:"Profile updated successfully"}}catch(t){return console.error("Error updating user profile:",t),{success:!1,error:t.message}}}async addAddress(e,r){try{const t=(0,o.doc)(s.db,"users",e),c=await(0,o.getDoc)(t);if(c.exists()){const e=c.data().addresses||[],s=(0,a.A)((0,a.A)({id:Date.now().toString()},r),{},{createdAt:new Date});return e.push(s),await(0,o.updateDoc)(t,{addresses:e,updatedAt:new Date}),{success:!0,address:s,message:"Address added successfully"}}}catch(t){return console.error("Error adding address:",t),{success:!1,error:t.message}}}async logout(){try{return await(0,c.CI)(s.j2),this.recaptchaVerifier=null,{success:!0,message:"Logged out successfully"}}catch(e){return console.error("Error logging out:",e),{success:!1,error:e.message}}}onAuthStateChanged(e){return(0,c.onAuthStateChanged)(s.j2,e)}cleanup(){this.recaptchaVerifier&&("function"===typeof this.recaptchaVerifier.clear&&this.recaptchaVerifier.clear(),this.recaptchaVerifier=null)}}}}]);
//# sourceMappingURL=816.31d81502.chunk.js.map